<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flasher Messaging ⚡ - Offline Private Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: sans-serif; transition: background 0.3s, color 0.3s; }
textarea { background: white !important; color: black !important; caret-color: black !important; }
.dark textarea { background: #111 !important; color: white !important; caret-color: white !important; }
#lightIndicator {
  width: 60px; height: 60px; border-radius: 50%;
  background: #ff0000; box-shadow: 0 0 20px #ff0000;
  transition: background 0.2s, box-shadow 0.2s;
}
</style>
</head>
<body class="bg-gray-900 dark:bg-gray-100 text-white dark:text-black min-h-screen flex flex-col items-center p-6">

<div class="w-full max-w-2xl flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold">Flasher Messaging ⚡</h1>
</div>

<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <label class="block mb-2 text-sm">Your Device Name</label>
  <input id="deviceName" type="text" placeholder="Enter your name..." class="w-full p-2 rounded">
</div>

<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <label class="block mb-2 text-sm">Message to Flash</label>
  <textarea id="flashMessage" placeholder="Type message..." class="w-full h-24 p-2 rounded"></textarea>
  <button onclick="sendFlashMessage()" class="w-full mt-3 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition">Send Flash</button>
</div>

<div class="w-full max-w-2xl bg-gray-800 dark:bg-gray-200 p-4 rounded-xl shadow-xl mb-6">
  <h2 class="font-bold mb-2">Receive Mode</h2>
  <p class="text-sm mb-2 opacity-80">Point your camera at the other device to join the private flash chat.</p>
  <button onclick="startReceive()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition">Start Receiving</button>
  <div id="status" class="p-2 mt-2 bg-gray-900 dark:bg-gray-100 rounded text-center"></div>
  <div id="receivedOutput" class="p-3 bg-black dark:bg-white text-green-400 dark:text-purple-700 rounded h-24 overflow-y-auto mt-3"></div>
</div>

<div class="w-full max-w-2xl flex flex-col items-center mb-6">
  <video id="video" autoplay playsinline class="w-full rounded-xl shadow-lg"></video>
  <div id="lightIndicator" class="mt-3"></div>
  <p class="mt-2 text-sm text-center opacity-70">Green when flash detected</p>
</div>

<script>
let stream;
let binaryBuffer = "";
let lastBitTime = 0;
const bitDuration = 150;
const preamble = "10101011";
let bitWindow = [];
let ambientBrightness = 0;
let lastBit = "0";
let state = "searchPreamble";
let peerName = "";
let sessionCode = "";

// generate random session code
function generateSessionCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let code = "";
  for(let i=0;i<6;i++) code+=chars[Math.floor(Math.random()*chars.length)];
  return code;
}

// init camera
async function initCamera() {
  if(stream) return;
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  document.getElementById("video").srcObject = stream;
}

// Flash sending
async function sendFlashMessage() {
  const msg = document.getElementById("flashMessage").value.trim();
  if(!msg) return alert("Enter a message first");
  await initCamera();
  const track = stream.getVideoTracks()[0];
  const caps = track.getCapabilities();
  if(!caps.torch) return alert("Torch not supported.");

  const deviceName = document.getElementById("deviceName").value || "Anonymous";
  if(!sessionCode) sessionCode = generateSessionCode(); // hidden session code

  // full message: preamble + session + name + message
  const fullMsgStr = `${sessionCode}\n${deviceName}\n${msg}`;
  const fullMsg = preamble + [...fullMsgStr].map(c=>c.charCodeAt(0).toString(2).padStart(8,'0')).join("");

  let i=0;
  function nextBit(){
    if(i>=fullMsg.length) return track.applyConstraints({ advanced:[{torch:false}] });
    track.applyConstraints({ advanced:[{torch:fullMsg[i]==='1'}]});
    i++;
    setTimeout(nextBit, bitDuration);
  }
  nextBit();
}

// Robust light detection
async function startReceive() {
  await initCamera();
  const video = document.getElementById("video");
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const indicator = document.getElementById("lightIndicator");
  const status = document.getElementById("status");
  binaryBuffer="";
  state="searchPreamble";
  bitWindow=[];
  ambientBrightness=0;
  lastBit="0";
  peerName="";
  let incomingSessionCode="";

  function readFrame(){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);
    const frame=ctx.getImageData(0,0,canvas.width,canvas.height).data;

    // sample center area for robust detection
    const startX=canvas.width*0.4|0, endX=canvas.width*0.6|0;
    const startY=canvas.height*0.4|0, endY=canvas.height*0.6|0;
    let brightnessSum=0, count=0;
    for(let y=startY;y<endY;y++){
      for(let x=startX;x<endX;x++){
        const idx=(y*canvas.width+x)*4;
        brightnessSum += frame[idx]+frame[idx+1]+frame[idx+2];
        count++;
      }
    }
    let brightness=brightnessSum/(count*3);
    ambientBrightness=ambientBrightness*0.9+brightness*0.1;
    const threshold=ambientBrightness*1.3;
    const bit=brightness>threshold?"1":"0";

    bitWindow.push(bit);
    if(bitWindow.length>5) bitWindow.shift();
    const majority = bitWindow.filter(b=>b==="1").length>2?"1":"0";

    const now=performance.now();
    if(now-lastBitTime>bitDuration*0.8 && majority!==lastBit){
      lastBitTime=now;
      lastBit=majority;
      indicator.style.background=majority==="1"?"#00ff00":"#ff0000";
      indicator.style.boxShadow=majority==="1"?"0 0 30px #00ff00":"0 0 20px #ff0000";
      binaryBuffer+=majority;

      // decode messages
      if(state==="searchPreamble"){
        if(binaryBuffer.endsWith(preamble)){
          state="receiveSession";
          binaryBuffer="";
        } else if(binaryBuffer.length>preamble.length*2){
          binaryBuffer=binaryBuffer.slice(-preamble.length);
        }
      } else if(state==="receiveSession"){
        if(binaryBuffer.length===8){
          const char=String.fromCharCode(parseInt(binaryBuffer,2));
          if(!incomingSessionCode) incomingSessionCode+=char;
          else if(!peerName) peerName+=char;
          else document.getElementById("receivedOutput").innerText+=char;
          binaryBuffer="";
          if(peerName) status.innerText=`You are synced in a private flash chat with ${peerName}`;
          else status.innerText=`Receiving session...`;
        }
      }
    }

    requestAnimationFrame(readFrame);
  }

  readFrame();
}
</script>
</body>
</html>
